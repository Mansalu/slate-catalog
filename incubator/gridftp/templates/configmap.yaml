apiVersion: v1
kind: ConfigMap
metadata:
  name: gridftp-entrypoint
  labels:
    app: gridftp 
    instance: {{ .Values.Instance }}
data:
  docker-entrypoint.sh: |-
    #!/bin/bash -e
    
    cp /opt/gridftp/x509/usercert.pem /home/gridftp/.globus/usercert.pem
    chmod 644 /home/gridftp/.globus/usercert.pem
    cp /opt/gridftp/x509/userkey.pem /home/gridftp/.globus/userkey.pem
    chmod 400 /home/gridftp/.globus/userkey.pem
    chown gridftp:gridftp /home/gridftp/.globus/userkey.pem
    chown gridftp:gridftp /home/gridftp/.globus/usercert.pem
    chown gridftp:gridftp /scratch
    cp /tmp/gridftp-host-pems/hostcert.pem /etc/grid-security/
    chmod 644 /etc/grid-security/hostcert.pem
    chown root:root /etc/grid-security/hostcert.pem
    cp /tmp/gridftp-host-pems/hostkey.pem /etc/grid-security/
    chmod 400 /etc/grid-security/hostkey.pem
    chown root:root /etc/grid-security/hostkey.pem
    opensslDN=$(openssl x509 -in /home/gridftp/.globus/usercert.pem -subject -noout)
    echo ${opensslDN:9}
    echo -e "\"${opensslDN:9}\" gridftp" > /etc/grid-security/grid-mapfile
    globus-gridftp-server
